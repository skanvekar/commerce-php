"use strict";(self.webpackChunkcommerce_php=self.webpackChunkcommerce_php||[]).push([[42078],{30732:function(e,a,r){r.r(a),r.d(a,{_frontmatter:function(){return p},default:function(){return c}});var n=r(87462),t=r(63366),o=(r(15007),r(64983)),m=r(91515),s=r(1930),i=["components"],p={},d={_frontmatter:p},l=m.Z;function c(e){var a=e.components,r=(0,t.Z)(e,i);return(0,o.mdx)(l,(0,n.Z)({},d,r,{components:a,mdxType:"MDXLayout"}),(0,o.mdx)(s.default,{mdxType:"Docs"}),(0,o.mdx)("h1",{id:"error-code-mapping"},"Error Code Mapping"),(0,o.mdx)("p",null,"A payment gateway has error codes or messages that need to be transformed to user-friendly messages. When an error occurs, Adobe Commerce delivers the message to the appropriate audience so that the customer or merchant can resolve any problems. You can set up each payment integration to map the native error codes and messages into sets of text strings. As a result, you can ensure that only the proper audience (merchants only, customers only, or all) sees each error message. By default, the standard error message (",(0,o.mdx)("inlineCode",{parentName:"p"},"An error occurred on the server. Please try to place the order again."),") displays if a payment operation fails and a specific mapped message cannot be found."),(0,o.mdx)("p",null,"Commerce provides the ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.4/app/code/Magento/Payment/Gateway/ErrorMapper/ErrorMessageMapperInterface.php"},(0,o.mdx)("inlineCode",{parentName:"a"},"\\Magento\\Payment\\Gateway\\ErrorMapper\\ErrorMessageMapperInterface"))," interface and default mapper implementation at ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.4/app/code/Magento/Payment/Gateway/ErrorMapper/ErrorMessageMapper.php"},(0,o.mdx)("inlineCode",{parentName:"a"},"\\Magento\\Payment\\Gateway\\ErrorMapper\\ErrorMessageMapper"))," to enable customizations."),(0,o.mdx)("p",null,"This topic uses examples based on the Commerce Braintree payment integration to illustrate how to enable error code mapping."),(0,o.mdx)("h2",{id:"implement-mapping-files"},"Implement mapping files"),(0,o.mdx)("p",null,"In most cases, you must define one or more mapping files and configure the default implementation of ",(0,o.mdx)("inlineCode",{parentName:"p"},"ErrorMessageMapperInterface")," using the module's ",(0,o.mdx)("inlineCode",{parentName:"p"},"di.xml")," file. Alternatively, you can implement a programmatic solution described in ",(0,o.mdx)("a",{parentName:"p",href:"#retrieve-error-codes-from-the-response-validator"},"Retrieve error codes from the response validator"),"."),(0,o.mdx)("h3",{id:"map-the-messages"},"Map the messages"),(0,o.mdx)("p",null,"The first step is to create one or more XML files that map message codes to messages. We recommend naming these files ",(0,o.mdx)("inlineCode",{parentName:"p"},"<gateway_name>_error_mapping.xml"),", but you can use any name you like. If you create more than one mapping file, each file must have the same file name. Use the following table to determine where to place mapping files:"),(0,o.mdx)("table",null,(0,o.mdx)("thead",{parentName:"table"},(0,o.mdx)("tr",{parentName:"thead"},(0,o.mdx)("th",{parentName:"tr",align:null},"Audience"),(0,o.mdx)("th",{parentName:"tr",align:null},"location"))),(0,o.mdx)("tbody",{parentName:"table"},(0,o.mdx)("tr",{parentName:"tbody"},(0,o.mdx)("td",{parentName:"tr",align:null},"All users"),(0,o.mdx)("td",{parentName:"tr",align:null},(0,o.mdx)("inlineCode",{parentName:"td"},"<module>/etc"))),(0,o.mdx)("tr",{parentName:"tbody"},(0,o.mdx)("td",{parentName:"tr",align:null},"Merchants"),(0,o.mdx)("td",{parentName:"tr",align:null},(0,o.mdx)("inlineCode",{parentName:"td"},"<module>/adminhtml"))),(0,o.mdx)("tr",{parentName:"tbody"},(0,o.mdx)("td",{parentName:"tr",align:null},"Customers"),(0,o.mdx)("td",{parentName:"tr",align:null},(0,o.mdx)("inlineCode",{parentName:"td"},"<module>/frontend"))))),(0,o.mdx)("p",null,"The files placed in the ",(0,o.mdx)("inlineCode",{parentName:"p"},"adminhtml")," and ",(0,o.mdx)("inlineCode",{parentName:"p"},"frontend")," directories ensure that customers and store administrators see only audience-specific messages. For example, a customer should see error messages when a credit card fails verification due to mis-entered data and similar reasons. The store's administrator should have more detailed descriptions of why an attempt to create an invoice or refund failed."),(0,o.mdx)("p",null,"The ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.3/app/code/Magento/Braintree/etc/braintree_error_mapping.xml"},"braintree_error_mapping.xml")," file provides an example collection:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-xml"},'<mapping xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:module:Magento_Payment:etc/error_mapping.xsd">\n    <message_list>\n        <message code="81703" translate="true">Credit card type is not accepted by this merchant account.</message>\n        <message code="81706" translate="true">CVV is required.</message>\n        <message code="81707" translate="true">CVV must be 4 digits for American Express and 3 digits for other card types.</message>\n        ...\n    </message_list>\n</mapping>\n')),(0,o.mdx)("p",null,"The message definitions are based on the ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.4/app/code/Magento/Payment/etc/error_mapping.xsd"},"error_mapping.xsd")," schema. Messages must comply with the following structure:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("p",{parentName:"li"},(0,o.mdx)("inlineCode",{parentName:"p"},"message_list")," --- the root node. It can contain a list of specific messages")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("p",{parentName:"li"},(0,o.mdx)("inlineCode",{parentName:"p"},"message")," --- the node, which contains the customized message and two attributes"),(0,o.mdx)("ul",{parentName:"li"},(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("p",{parentName:"li"},(0,o.mdx)("inlineCode",{parentName:"p"},"code")," --- the error code returned from the payment gateway. The value can be numeric or string")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("p",{parentName:"li"},(0,o.mdx)("inlineCode",{parentName:"p"},"translate")," --- a boolean attribute that determines whether to collect all message translations"))))),(0,o.mdx)("h3",{id:"configure-dependency-injection"},"Configure dependency injection"),(0,o.mdx)("p",null,"After you map the messages, you must specify the location of the error mapping file or files for the config reader. To do this, create a ",(0,o.mdx)("inlineCode",{parentName:"p"},"virtualType")," definition for ",(0,o.mdx)("inlineCode",{parentName:"p"},"\\Magento\\Payment\\Gateway\\ErrorMapper\\VirtualConfigReader")," in the module's ",(0,o.mdx)("inlineCode",{parentName:"p"},"di.xml")," file:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-xml"},'<virtualType name="Magento\\Braintree\\Gateway\\ErrorMapper\\VirtualConfigReader" type="Magento\\Payment\\Gateway\\ErrorMapper\\VirtualConfigReader">\n    <arguments>\n        <argument name="fileName" xsi:type="string">braintree_error_mapping.xml</argument>\n    </arguments>\n</virtualType>\n')),(0,o.mdx)("p",null,"Also, specify a config instance for the data reader. You can also provide your own ",(0,o.mdx)("inlineCode",{parentName:"p"},"cacheId"),", which allows you to store all parsed messages in a cache."),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-xml"},'<virtualType name="Magento\\Braintree\\Gateway\\ErrorMapper\\VirtualMappingData" type="Magento\\Payment\\Gateway\\ErrorMapper\\MappingData">\n    <arguments>\n        <argument name="reader" xsi:type="object">Magento\\Braintree\\Gateway\\ErrorMapper\\VirtualConfigReader</argument>\n        <argument name="cacheId" xsi:type="string">braintree_error_mapper</argument>\n    </arguments>\n</virtualType>\n')),(0,o.mdx)("p",null,"Then customize the default ",(0,o.mdx)("inlineCode",{parentName:"p"},"ErrorMessageMapper")," via virtual type and specify the data reader:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-xml"},'<virtualType name="Magento\\Braintree\\Gateway\\ErrorMapper\\VirtualErrorMessageMapper" type="Magento\\Payment\\Gateway\\ErrorMapper\\ErrorMessageMapper">\n    <arguments>\n        <argument name="messageMapping" xsi:type="object">Magento\\Braintree\\Gateway\\ErrorMapper\\VirtualMappingData</argument>\n    </arguments>\n</virtualType>\n')),(0,o.mdx)("p",null,"Because Braintree integration uses the default ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.4/app/code/Magento/Payment/Gateway/Command/GatewayCommand.php"},(0,o.mdx)("inlineCode",{parentName:"a"},"Magento\\Payment\\Gateway\\Command\\GatewayCommand")),",\ninject the created mapper pool to the required ",(0,o.mdx)("a",{parentName:"p",href:"/commerce-php/gateway-command.md"},"gateway command")," as an argument:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-xml"},'<virtualType name="BraintreeAuthorizeCommand" type="Magento\\Payment\\Gateway\\Command\\GatewayCommand">\n    <arguments>\n        ...\n        <argument name="errorMessageMapper" xsi:type="object">Magento\\Braintree\\Gateway\\ErrorMapper\\VirtualErrorMessageMapper</argument>\n    </arguments>\n</virtualType>\n')),(0,o.mdx)("p",null,"The ",(0,o.mdx)("inlineCode",{parentName:"p"},"Magento\\Payment\\Gateway\\Command\\GatewayCommand")," allows you to retrieve multiple error messages, but if your integration\ndoes not use this feature, you can inject ",(0,o.mdx)("inlineCode",{parentName:"p"},"ErrorMessageMapperInterface")," to it as an argument. Then implement your own logic to the mapper error codes."),(0,o.mdx)("p",null,"The payment integration should now retrieve error codes from the payment gateway response."),(0,o.mdx)("h2",{id:"retrieve-error-codes-from-the-response-validator"},"Retrieve error codes from the response validator"),(0,o.mdx)("p",null,"You can retrieve errors codes using a ",(0,o.mdx)("a",{parentName:"p",href:"/commerce-php/response-validator.md"},"response validator"),".\nA response validator verifies response codes from the payment gateway.\nIt has different responsibilities and should not map messages, because it works on the lower layer of communication between Commerce and the payment gateway.\nIt is the responsibility of a gateway command to call an appropriate service."),(0,o.mdx)("p",null,"For example, Commerce provides a response validator for Braintree: ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.3/app/code/Magento/Braintree/Gateway/Validator/GeneralResponseValidator.php"},(0,o.mdx)("inlineCode",{parentName:"a"},"\\Magento\\Braintree\\Gateway\\Validator\\GeneralResponseValidator")),".\nIts implementation allows to retrieve errors codes from a response."),(0,o.mdx)("p",null,"First, create a new code provider. It can be a simple class with a public method that should return a list of error codes by the provided response:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"class ErrorCodeProvider\n{\n    /**\n     * Retrieves list of error codes from Braintree response.\n     *\n     * @param Successful|Error $response\n     * @return array\n     */\n    public function getErrorCodes($response): array\n    {\n        $result = [];\n        if (!$response instanceof Error) {\n            return $result;\n        }\n\n        /** @var ErrorCollection $collection */\n        $collection = $response->errors;\n\n        /** @var Validation $error */\n        foreach ($collection->deepAll() as $error) {\n            $result[] = $error->code;\n        }\n\n        return $result;\n    }\n}\n")),(0,o.mdx)("p",null,"Then add the created provider as a dependency to the ",(0,o.mdx)("inlineCode",{parentName:"p"},"GeneralResponseValidator")," class:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-php"},"class GeneralResponseValidator extends AbstractValidator\n{\n    public function __construct(\n        ResultInterfaceFactory $resultFactory,\n        SubjectReader $subjectReader,\n        ErrorCodeProvider $errorCodeProvider\n    ) {\n        parent::__construct($resultFactory);\n        $this->subjectReader = $subjectReader;\n        $this->errorCodeProvider = $errorCodeProvider;\n    }\n\n    public function validate(array $validationSubject)\n    {\n        /** @var Successful|Error $response */\n        $response = $this->subjectReader->readResponseObject($validationSubject);\n\n        $isValid = true;\n        $errorMessages = [];\n\n        foreach ($this->getResponseValidators() as $validator) {\n            $validationResult = $validator($response);\n\n            if (!$validationResult[0]) {\n                $isValid = $validationResult[0];\n                $errorMessages = array_merge($errorMessages, $validationResult[1]);\n            }\n        }\n        $errorCodes = $this->errorCodeProvider->getErrorCodes($response);\n\n        return $this->createResult($isValid, $errorMessages, $errorCodes);\n    }\n}\n")),(0,o.mdx)("p",null,"The ",(0,o.mdx)("inlineCode",{parentName:"p"},"GeneralResponseValidator")," returns an implementation of ",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/magento/magento2/tree/2.4/app/code/Magento/Payment/Gateway/Validator/ResultInterface.php"},(0,o.mdx)("inlineCode",{parentName:"a"},"\\Magento\\Payment\\Gateway\\Validator\\ResultInterface")),"\nand the ",(0,o.mdx)("inlineCode",{parentName:"p"},"\\Magento\\Payment\\Gateway\\Command\\GatewayCommand")," uses method ",(0,o.mdx)("inlineCode",{parentName:"p"},"ResultInterface::getErrorCodes()")," method to map error codes to user-friendly messages."))}c.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-development-payments-integrations-payment-gateway-error-code-mapper-md-b06d6ef5d0edaf3e5013.js.map